name: Deploy Jupyter Notebooks to GitHub Pages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install nbconvert
        run: |
          python -m pip install --upgrade pip
          pip install nbconvert jupyter

      # -------------------------------------------------
      # 1. Convert .ipynb → .html (preserve folder tree)
      # -------------------------------------------------
      - name: Convert notebooks to HTML
        run: |
          find . -name '*.ipynb' -not -path './.github/*' -not -path './_site/*' | while read nb; do
            dir=$(dirname "$nb")
            base=$(basename "$nb" .ipynb)
            mkdir -p "_site/$dir"
            jupyter nbconvert --to html \
              --output-dir "_site/$dir" \
              --output "$base.html" \
              "$nb"
          done

      # -------------------------------------------------
      # 2. Generate a dropdown-style index.html
      # -------------------------------------------------
      - name: Generate index.html
        run: |
          cat > _site/index.html <<'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
          <meta charset="utf-8">
          <title>Jupyter Notebooks</title>
          <style>
            :root { --indent: 1.5rem; }
            body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 2rem; line-height: 1.6; background:#ffffff; color:#1a1a1a;}
            h1 {color:#2c3e50; margin-bottom:1.5rem; font-size:1.8rem;}
          
            details { margin: 0.25rem 0; }
            summary {
              font-weight: 600; color: #2980b9; cursor: pointer;
              list-style: none; padding: 0.25rem 0; position: relative;
              padding-left: var(--indent);
            }
            summary::before {
              content: "▶"; position: absolute; left: 0; font-size: 0.9rem;
            }
            details[open] > summary::before { content: "▼"; }
          
            summary::-webkit-details-marker { display: none; }
          
            ul { margin: 0.4rem 0 0.4rem var(--indent); padding: 0; list-style: none; }
            li { margin: 0.3rem 0; position: relative; padding-left: 1.2rem; }
            li::before { content: "•"; color:#7f8c8d; position: absolute; left:0; font-weight:bold; }
          
            a { color: #2980b9; text-decoration: none; font-family: 'Courier New', monospace; font-size: 0.95rem; }
            a:hover { text-decoration: underline; color:#1a73e8; }
          </style>
          </head>
          <body>
          <h1>Jupyter Notebooks</h1>
          <ul>
          EOF
          
          # ---------------------------------------------
          # BUILD DIRECTORY TREE STRUCTURE
          # ---------------------------------------------
          
          # List and sort directories first, then files
          mapfile -t entries < <(
            find _site -mindepth 1 -printf "%P\n" \
            | sort -t '/' -k1,1 -k2,2
          )
          
          current_depth=0
          
          for path in "${entries[@]}"; do
              full="_site/$path"
          
              # Count nesting depth
              depth=$(grep -o "/" <<< "$path" | wc -l)
          
              # Close levels if needed
              while (( depth < current_depth )); do
                  printf '%*s</ul></details>\n' $((current_depth*2)) "" >> _site/index.html
                  ((current_depth--))
              done
          
              basename=$(basename "$path")
          
              if [[ -d "$full" ]]; then
                  # Directory entry
                  printf '%*s<details><summary>%s/</summary><ul>\n' $((depth*2)) "" "$basename" >> _site/index.html
                  ((current_depth++))
              else
                  # File entry
                  printf '%*s<li><a href="%s">%s</a></li>\n' $(((depth+1)*2)) "" "$path" "$basename" >> _site/index.html
              fi
          done
          
          # Close remaining open lists
          while (( current_depth > 0 )); do
              printf '%*s</ul></details>\n' $((current_depth*2)) "" >> _site/index.html
              ((current_depth--))
          done
          
          # ---------------------------------------------
          # END HTML
          # ---------------------------------------------
          cat >> _site/index.html <<'EOF'
          </ul>
          </body>
          </html>
          EOF

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '_site/'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
